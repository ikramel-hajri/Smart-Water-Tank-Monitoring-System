<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Water Tank Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <div class="col text-center">
            <h2>Water Tank Monitoring Dashboard</h2>

            <!-- Water Tank Visualization -->
            <div class="row align-items-center justify-content-center">
                <div class="col-8" style="position: relative; height:75vh; width:80vw">
                    <!-- Draw Water Tank -->
                    <div
                        style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 1px solid #000; background-color: #b3e0ff;">
                        <!-- Water Level Indicator -->
                        <div
                            style="position: absolute; bottom: 0; left: 0; right: 0; height: 50%; background-color: #ff6666;">
                        </div>
                        <!-- Threshold Line -->
                        <div id="thresholdLine"
                            style="position: absolute; bottom: calc(50% - 1px); left: 0; right: 0; height: 3px; background-color: #000;">
                        </div>
                        <!-- Vertical Scale -->
                        <div
                            style="position: absolute; top: 0; right: 0; bottom: 0; width: 30px; background-color: #fff; display: flex; flex-direction: column; justify-content: space-between; padding: 5px;">
                            <span style="transform: scaleY(0); transform-origin: bottom;">0%</span>
                            <span style="transform: scaleY(0.25); transform-origin: bottom;">25%</span>
                            <span style="transform: scaleY(0.5); transform-origin: bottom;">50%</span>
                            <span style="transform: scaleY(0.75); transform-origin: bottom;">75%</span>
                            <span style="transform: scaleY(1); transform-origin: bottom;">100%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Threshold Range Input -->
            <div class="row align-items-center">
                <div class="col-5 text-end">Threshold:</div>
                <div class="col-4 text-start">
                    <input type="range" class="form-range" min="0" max="100" value="50" id="threshold">
                    <span id="thresholdValue">50</span>
                </div>
            </div>

            <!-- Chart for Historical Values -->
            <div class="row align-items-center justify-content-center">
                <div class="col-8" style="position: relative; height:50vh; width:80vw"><canvas id="myChart"></canvas>
                </div>
            </div>

            <!-- LED State Indicator -->
            <div class="row align-items-center">
                <div class="col-5 text-end">LED State:</div>
                <div class="col text-start">
                    <div class="btn-group" role="group" aria-label="LED State">
                        <input type="radio" class="btn-check" name="ledState" id="greenLedBtn" autocomplete="off">
                        <label class="btn btn-outline-success" for="greenLedBtn">Green</label>

                        <input type="radio" class="btn-check" name="ledState" id="redLedBtn" autocomplete="off">
                        <label class="btn btn-outline-danger" for="redLedBtn">Red</label>
                    </div>
                </div>
                <div class="col text-start">
                    <svg xmlns="http://www.w3.org/2000/svg" id="led" width="24" height="24" fill="black"
                        class="bi bi-lightbulb-fill" viewBox="0 0 16 16">
                        <path
                            d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13h-5a.5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm3 8.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1-.5-.5z" />
                    </svg>
                </div>
            </div>


        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js">
    </script>
    <script>
        // Chart
        const ctx = document.getElementById('myChart');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Water Level',
                    data: [],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: "time",
                        time: {
                            unit: "second"
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100 // Set the maximum scale to 100%
                    }
                }
            }
        });

        function addDataPoint(newTime, newWaterLevel) {
            myChart.data.labels.push(newTime);
            myChart.data.datasets.forEach((dataset) => {
                dataset.data.push(newWaterLevel);
            });
            myChart.update();
        }

        // WebSockets
        const telemetrySocket = new WebSocket(location.origin.replace(/^http/, 'ws') +
            "/distancesensor/telemetry.ws");
        const commandsSocket = new WebSocket(location.origin.replace(/^http/, 'ws') + "/distancesensor/commands.ws");


        telemetrySocket.onmessage = function (event) {
            const telemetry = JSON.parse(event.data);
            addDataPoint(telemetry.timestamp, telemetry.waterLevel);
            setLedState(telemetry.ledState);
            setThreshold(telemetry.threshold); // Assuming the server sends the threshold value
        };

        // Threshold Range Input
        const thresholdRange = document.getElementById('threshold');
        const thresholdValue = document.getElementById('thresholdValue');
        const thresholdLine = document.getElementById('thresholdLine');


        thresholdRange.oninput = function () {
        const newThreshold = thresholdRange.value;
        thresholdValue.textContent = newThreshold; // Update displayed value
        thresholdLine.style.bottom = `calc(${100 - newThreshold}% - 1px)`; // Update threshold line position
        sendThreshold(newThreshold);
        };
        
        function sendThreshold(threshold) {
            commandsSocket.send(JSON.stringify({"setThreshold": threshold}));
            waitForUpdateUI = true;
        }

        // LED State Indicator
        const greenLedBtn = document.getElementById('greenLedBtn');
        const redLedBtn = document.getElementById('redLedBtn');
        const led = document.getElementById('led');

        function setLedState(state) {
            if (state === "Green") {
                greenLedBtn.checked = true;
                led.setAttribute("fill", "green");
            } else if (state === "Red") {
                redLedBtn.checked = true;
                led.setAttribute("fill", "red");
            }
        }
        function sendLedState(state) {
            commandsSocket.send(JSON.stringify({"setLedState": state}));
            waitForUpdateUI = true;
        }

    </script>
</body>

</html>